{% extends "base.html" %}

{% block content %}
<h1>DHCP Leases</h1>
{% if server_config %}
<p>DHCP Server: {{ server_config.dhcp_server_ip }}</p>
{% else %}
<p>DHCP Server: Not configured</p>
{% endif %}

<!-- Форма поиска -->
<form method="GET" action="{{ url_for('main.index') }}" class="mb-3">
    <div class="input-group">
        <input type="text" class="form-control" name="q" placeholder="Search by IP or Hostname"
               value="{{ search_query }}">
        <button type="submit" class="btn btn-primary">Search</button>
        {% if search_query %}
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Clear</a>
        {% endif %}
    </div>
</form>


<table class="table table-striped" id="leases-table">
    <thead>
    <tr>
        <th>IP Address</th>
        <th>MAC Address</th>
        <th>Hostname</th>
        <th>Starts</th>
        <th>Ends</th>
        <th>State</th>
        <th>UID</th>
        <th>Online</th>
        <th>Last Check</th>
        <th>In Work</th>
        <th>Taken By</th>
        <th>Status</th>
        <!--  Убрали проверку роли для отображения столбца Actions  -->
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for lease in leases.items %}
    <tr>
        <td><a href="http://{{ lease.ip }}" target="_blank">{{ lease.ip }}</a></td>
        <td>{{ lease.mac }}</td>
        <td>{{ lease.hostname }}</td>
        <td>{{ lease.starts|default('', true) }}</td>
        <td>{{ lease.ends|default('', true) }}</td>
        <td>{{ lease.binding_state }}</td>
        <td>{{ lease.uid|default('', true) }}</td>
        <td class="status-cell" data-ip="{{ lease.ip }}">
            {{ "Online" if lease.is_online else "Offline" }}
        </td>
        <td>{{ lease.last_check|default('', true) }}</td>
        <td>
            {% if lease.status == 'in_work' %}
            <span class="badge bg-warning">In Work</span>
            {% endif %}
        </td>
        <td>{{ lease.taken_user.username if lease.taken_user else '' }}</td>
        <td>{{ lease.status }}</td>
        <td>  <!--  Убрали проверку роли для отображения кнопок -->
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-primary take-btn" data-lease-id="{{ lease.id }}">Take</button>
                <button class="btn btn-sm btn-warning complete-btn" data-lease-id="{{ lease.id }}">Complete</button>
                <button class="btn btn-sm btn-info pending-btn" data-lease-id="{{ lease.id }}">Pending</button>
                <button class="btn btn-sm btn-danger broken-btn" data-lease-id="{{ lease.id }}">Broken</button>
                {% if current_user.role == 'admin' %}  <!--  Проверка роли ТОЛЬКО для Delete -->
                <button class="btn btn-sm btn-danger delete-btn" data-lease-id="{{ lease.id }}">Delete</button>
                {% endif %}
            </div>
        </td>

    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Пагинация -->
<nav aria-label="Page navigation">
    <ul class="pagination">
        {% if leases.has_prev %}
        <li class="page-item"><a class="page-link"
                                 href="{{ url_for('main.index', page=leases.prev_num, q=search_query) }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
        {% endif %}

        {% for page_num in leases.iter_pages() %}
        {% if page_num %}
        {% if page_num == leases.page %}
        <li class="page-item active"><a class="page-link" href="#">{{ page_num }}</a></li>
        {% else %}
        <li class="page-item"><a class="page-link"
                                 href="{{ url_for('main.index', page=page_num, q=search_query) }}">{{ page_num }}</a>
        </li>
        {% endif %}
        {% else %}
        <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
        {% endif %}
        {% endfor %}

        {% if leases.has_next %}
        <li class="page-item"><a class="page-link"
                                 href="{{ url_for('main.index', page=leases.next_num, q=search_query) }}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
        {% endif %}
    </ul>
</nav>

<script>
    $(document).ready(function() {
    //  Получаем CSRF-токен из мета-тега
    var csrfToken = $('meta[name="csrf-token"]').attr('content');

    // Функция обновления таблицы (с учетом пагинации и поиска)
    function updateTable(page, searchQuery) {
        $.ajax({
            url: "{{ url_for('main.update_table') }}",
            type: "GET",
            dataType: "json",
            data: { page: page, q: searchQuery },
            success: function(data) {
                let tbody = $("#leases-table tbody");
                tbody.empty();

                data.forEach(function(lease) {
                    //  Убедитесь, что здесь используются правильные имена классов
                    let row = `<tr>
                        <td><a href="http://${lease.ip}" target="_blank">${lease.ip}</a></td>
                        <td>${lease.mac}</td>
                        <td>${lease.hostname || ''}</td>
                        <td>${lease.starts || ''}</td>
                        <td>${lease.ends || ''}</td>
                        <td>${lease.binding_state}</td>
                        <td>${lease.uid || ''}</td>
                        <td class="status-cell" data-ip="${lease.ip}">${lease.is_online ? "Online" : "Offline"}</td>
                        <td>${lease.last_check || ''}</td>
                        <td>
                            ${lease.in_work ?
                                `<span class="badge bg-warning">In Work</span>`
                                : ''}
                        </td>
                        <td>${lease.taken_by || ''}</td>
                        <td>${lease.status}</td>
                        ${"{{ current_user.role }}" === 'admin' ? `<td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary take-btn" data-lease-id="${lease.id}">Take</button>
                                <button class="btn btn-sm btn-warning complete-btn" data-lease-id="${lease.id}">Complete</button>
                                <button class="btn btn-sm btn-info pending-btn" data-lease-id="${lease.id}">Pending</button>
                                <button class="btn btn-sm btn-danger broken-btn" data-lease-id="${lease.id}">Broken</button>
                                <button class="btn btn-sm btn-danger delete-btn" data-lease-id="${lease.id}">Delete</button>
                            </div>
                        </td>` : ''}
                    </tr>`;
                    tbody.append(row);
                });

                attachButtonHandlers();
                updateButtonVisibility(); // Обновляем видимость кнопок
            },
            error: function(xhr, status, error) {
                console.error("Error updating table:", error);
            }
        });
    }

    // ... (остальной JavaScript код - без изменений) ...
     // Обработчики кнопок
        function attachButtonHandlers() {
            $(".take-btn").off('click').on('click', function (event) {
                event.preventDefault();
                let leaseId = $(this).data("lease-id");
                $.ajax({
                    url: `/api/leases/${leaseId}/take`,
                    type: "POST",
                    data: {csrf_token: csrfToken},  //  Передаём CSRF-токен
                    success: function (response) {
                        console.log(response.message);
                        updateTable({{ leases.page|default(1, true) }}, "{{ search_query|default('', true) }}");
                    },
                    error: function (xhr, status, error) {
                        console.error("Error taking lease:", error);
                        alert(xhr.responseJSON.message);
                    }
                });
            });

            //  Отдельные обработчики для Complete, Pending, Broken
            $(".complete-btn").off('click').on('click', function (event) {
                event.preventDefault();
                let leaseId = $(this).data("lease-id");
                $.ajax({
                    url: `/api/leases/${leaseId}/complete`, //  НОВЫЙ URL
                    type: "POST",  //  Используем POST
                    data: {csrf_token: csrfToken},
                    success: function (response) {
                        console.log(response.message);
                        updateTable({{ leases.page|default(1, true) }}, "{{ search_query|default('', true) }}");
                    },
                    error: function (xhr, status, error) {
                        console.error("Error completing lease:", error);
                        alert(xhr.responseJSON.message);
                    }
                });
            });

            $(".pending-btn").off('click').on('click', function (event) {
                event.preventDefault();
                let leaseId = $(this).data("lease-id");
                $.ajax({
                    url: `/api/leases/${leaseId}/pending`, //  НОВЫЙ URL
                    type: "POST",
                    data: {csrf_token: csrfToken},
                    success: function (response) {
                        console.log(response.message);
                        updateTable({{ leases.page|default(1, true) }}, "{{ search_query|default('', true) }}");
                    },
                    error: function (xhr, status, error) {
                        console.error("Error setting lease to pending:", error);
                        alert(xhr.responseJSON.message);
                    }
                });
            });
            $(".broken-btn").off('click').on('click', function (event) {
                event.preventDefault();
                let leaseId = $(this).data("lease-id");
                $.ajax({
                    url: `/api/leases/${leaseId}/broken`, //  НОВЫЙ URL
                    type: "POST",
                    data: {csrf_token: csrfToken},
                    success: function (response) {
                        console.log(response.message);
                        updateTable({{ leases.page|default(1, true) }}, "{{ search_query|default('', true) }}");
                    },
                    error: function (xhr, status, error) {
                        console.error("Error setting lease to broken:", error);
                        alert(xhr.responseJSON.message);
                    }
                });
            });

            $(".delete-btn").off('click').on('click', function (event) {
                event.preventDefault();
                let leaseId = $(this).data("lease-id");
                if (confirm("Are you sure you want to delete this lease?")) {
                    $.ajax({
                        url: `/api/leases/${leaseId}`,
                        type: "DELETE",
                        data: {csrf_token: csrfToken},  //  Передаём CSRF-токен
                        success: function (response) {
                            console.log(response.message);
                            updateTable({{ leases.page|default(1, true) }}, "{{ search_query|default('', true) }}");
                        },
                        error: function (xhr, status, error) {
                            console.error("Error deleting lease:", error);
                            alert(xhr.responseJSON.message);
                        }
                    });
                }
            });
        }

      // Функция для обновления видимости кнопок на основе данных
        function updateButtonVisibility() {
            $(".take-btn, .complete-btn, .pending-btn, .broken-btn, .reset-btn").hide(); // Сначала скрываем все

            // Перебираем строки таблицы и показываем нужные кнопки
            $("#leases-table tbody tr").each(function() {
                let status = $(this).find("td:eq(11)").text().trim(); // Получаем текст из столбца "Status"
               // let leaseId = $(this).find(".take-btn").data("lease-id"); // Получаем lease-id (он одинаковый для всех кнопок)

                if (status === 'active') {
                    $(this).find(".take-btn").show();
                } else if (status === 'in_work') {
                    $(this).find(".complete-btn").show();
                } else if (status === 'pending') {
                    $(this).find(".pending-btn").show();
                }
                else if (status === 'broken') {
                    $(this).find(".broken-btn").show();
                }
                 else if (status === 'completed') { //  Добавили для кнопки reset
                    $(this).find(".reset-btn").show();
                }
            });
        }


        attachButtonHandlers();
        //  Вызываем updateButtonVisibility при первой загрузке и после обновления
        updateButtonVisibility();

        // Обработчик изменения состояния чекбокса "Только мои"
        $("#show-my-leases").change(function() {
            updateTable({{ leases.page|default(1, true) }}, "{{ search_query|default('', true) }}");
        });

    });
</script>
{% endblock %}